# Frontend container
upstream ddbj-search-front {
  server ddbj-search-front-${DDBJ_SEARCH_ENV}:3000;
  keepalive 8;
}

# API Server container
upstream ddbj-search-api {
  server ddbj-search-api-${DDBJ_SEARCH_ENV}:8080;
  keepalive 8;
}

server {
  listen 80;
  listen [::]:80;
  server_name _;

  # --- Common proxy settings (inherited by all location blocks) ---
  proxy_http_version 1.1;
  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto https;
  proxy_set_header Connection "";

  # Bulk POST body size (up to 1000 IDs)
  client_max_body_size 1m;

  # === Special case: entry detail as JSON/JSONLD ===
  # Frontend URL with .json/.jsonld extension -> rewrite to API path -> API Server
  # e.g. /search/entry/bioproject/PRJNA16.json -> /search/api/entries/bioproject/PRJNA16.json
  location ~ ^/search/entry/([^/]+)/([^/]+)\.(json|jsonld)$ {
    rewrite ^/search/entry/(.+)\.(json|jsonld)$ /search/api/entries/$1.$2 break;
    proxy_pass http://ddbj-search-api;
  }

  # === API Server ===
  # Pass-through: no path rewrite, backend receives full path
  location /search/api {
    proxy_pass http://ddbj-search-api;
  }

  # === Elasticsearch read-only proxy (optional) ===
  # Enable by setting DDBJ_SEARCH_ES_ENABLED=true in .env
  # Allowed: _search, _msearch (GET/POST), _doc (GET)

  location ~ ^/search/resources/[^/]+/(_search|_msearch)$ {
    set $es_enabled "${DDBJ_SEARCH_ES_ENABLED}";
    if ($es_enabled != "true") {
      return 404;
    }

    limit_except GET POST {
      deny all;
    }

    resolver 127.0.0.11 valid=30s;
    set $es_backend "http://ddbj-search-es-${DDBJ_SEARCH_ENV}:9200";
    rewrite ^/search/resources(.*)$ $1 break;
    proxy_pass $es_backend;
  }

  location ~ ^/search/resources/[^/]+/_doc/[^/]+$ {
    set $es_enabled "${DDBJ_SEARCH_ES_ENABLED}";
    if ($es_enabled != "true") {
      return 404;
    }

    limit_except GET {
      deny all;
    }

    resolver 127.0.0.11 valid=30s;
    set $es_backend "http://ddbj-search-es-${DDBJ_SEARCH_ENV}:9200";
    rewrite ^/search/resources(.*)$ $1 break;
    proxy_pass $es_backend;
  }

  # === Backward compatibility redirects ===

  # prev: https://ddbj.nig.ac.jp/resource/bioproject/PRJDB12105
  # new: https://ddbj.nig.ac.jp/search/entry/bioproject/PRJDB12105
  location /resource {
    rewrite ^/resource(.*)$ https://$host/search/entry$1 permanent;
  }

  # prev: https://ddbj.nig.ac.jp/entry/bioproject/PRJDB12105
  # new: https://ddbj.nig.ac.jp/search/entry/bioproject/PRJDB12105
  location /entry {
    rewrite ^/entry(.*)$ https://$host/search/entry$1 permanent;
  }

  # === Frontend (catch-all) ===
  location /search {
    proxy_pass http://ddbj-search-front;
  }
}
